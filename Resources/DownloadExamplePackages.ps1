$ForceDownload = @(
    [PSObject]@{
        ID = "Microsoft.Bcl.AsyncInterfaces";
        Version = "7.0.0";
        ExistsLocally = $false;
    },
    [PSObject]@{
        ID = "System.Text.Encodings.Web";
        Version = "7.0.0";
        ExistsLocally = $false;
    },
    [PSObject]@{
        ID = "System.Buffers";
        Version = "4.5.1";
        ExistsLocally = $false;
    },
    [PSObject]@{
        ID = "System.Memory";
        Version = "4.5.5";
        ExistsLocally = $false;
    },
    [PSObject]@{
        ID = "System.Numerics.Vectors";
        Version = "4.5.0";
        ExistsLocally = $false;
    },
    [PSObject]@{
        ID = "System.Runtime.CompilerServices.Unsafe";
        Version = "6.0.0";
        ExistsLocally = $false;
    },
    [PSObject]@{
        ID = "System.Threading.Tasks.Extensions";
        Version = "4.5.4";
        ExistsLocally = $false;
    },
    [PSObject]@{
        ID = "System.ValueTuple";
        Version = "4.5.0";
        ExistsLocally = $false;
    },
    [PSObject]@{
        ID = "Microsoft.Bcl.AsyncInterfaces";
        Version = "8.0.0-preview.7.23375.6";
        ExistsLocally = $false;
    },
    [PSObject]@{
        ID = "System.Text.Encodings.Web";
        Version = "8.0.0-preview.7.23375.6";
        ExistsLocally = $false;
    },
    [PSObject]@{
        ID = "Microsoft.Bcl.AsyncInterfaces";
        Version = "8.0.0-rc.1.23419.4";
        ExistsLocally = $false;
    },
    [PSObject]@{
        ID = "System.Text.Encodings.Web";
        Version = "8.0.0-rc.1.23419.4";
        ExistsLocally = $false;
    },
    [PSObject]@{
        ID = "Microsoft.Bcl.AsyncInterfaces";
        Version = "8.0.0-rc.2.23479.6";
        ExistsLocally = $false;
    },
    [PSObject]@{
        ID = "System.Text.Encodings.Web";
        Version = "8.0.0-rc.2.23479.6";
        ExistsLocally = $false;
    },
    [PSObject]@{
        ID = "Microsoft.Bcl.AsyncInterfaces";
        Version = "8.0.0";
        ExistsLocally = $false;
    },
    [PSObject]@{
        ID = "System.Text.Encodings.Web";
        Version = "8.0.0";
        ExistsLocally = $false;
    },
    [PSObject]@{
        ID = "Microsoft.Bcl.AsyncInterfaces";
        Version = "1.0.0";
        ExistsLocally = $true;
    },
    [PSObject]@{
        ID = "System.Buffers";
        Version = "4.5.0";
        ExistsLocally = $true;
    },
    [PSObject]@{
        ID = "System.Runtime.CompilerServices.Unsafe";
        Version = "4.6.0";
        ExistsLocally = $true;
    },
    [PSObject]@{
        ID = "System.Text.Encodings.Web";
        Version = "4.6.0";
        ExistsLocally = $true;
    },
    [PSObject]@{
        ID = "System.Memory";
        Version = "4.5.3";
        ExistsLocally = $true;
    },
    [PSObject]@{
        ID = "System.Numerics.Vectors";
        Version = "4.5.0";
        ExistsLocally = $true;
    },
    [PSObject]@{
        ID = "System.Threading.Tasks.Extensions";
        Version = "4.5.2";
        ExistsLocally = $true;
    },
    [PSObject]@{
        ID = "System.ValueTuple";
        Version = "4.5.0";
        ExistsLocally = $true;
    },
    [PSObject]@{
        ID = "Microsoft.Bcl.AsyncInterfaces";
        Version = "1.1.0";
        ExistsLocally = $true;
    },
    [PSObject]@{
        ID = "System.Runtime.CompilerServices.Unsafe";
        Version = "4.7.0";
        ExistsLocally = $true;
    },
    [PSObject]@{
        ID = "System.Text.Encodings.Web";
        Version = "4.7.0";
        ExistsLocally = $true;
    },
    [PSObject]@{
        ID = "System.Buffers";
        Version = "4.5.1";
        ExistsLocally = $true;
    },
    [PSObject]@{
        ID = "System.Runtime.CompilerServices.Unsafe";
        Version = "4.7.1";
        ExistsLocally = $true;
    },
    [PSObject]@{
        ID = "System.Text.Encodings.Web";
        Version = "4.7.1";
        ExistsLocally = $true;
    },
    [PSObject]@{
        ID = "System.Memory";
        Version = "4.5.4";
        ExistsLocally = $true;
    },
    [PSObject]@{
        ID = "System.Threading.Tasks.Extensions";
        Version = "4.5.4";
        ExistsLocally = $true;
    },
    [PSObject]@{
        ID = "Microsoft.Bcl.AsyncInterfaces";
        Version = "5.0.0";
        ExistsLocally = $true;
    },
    [PSObject]@{
        ID = "System.Runtime.CompilerServices.Unsafe";
        Version = "5.0.0";
        ExistsLocally = $true;
    },
    [PSObject]@{
        ID = "System.Text.Encodings.Web";
        Version = "5.0.0";
        ExistsLocally = $true;
    },
    [PSObject]@{
        ID = "System.Text.Encodings.Web";
        Version = "5.0.1";
        ExistsLocally = $true;
    },
    [PSObject]@{
        ID = "Microsoft.Bcl.AsyncInterfaces";
        Version = "6.0.0";
        ExistsLocally = $true;
    },
    [PSObject]@{
        ID = "System.Runtime.CompilerServices.Unsafe";
        Version = "6.0.0";
        ExistsLocally = $true;
    },
    [PSObject]@{
        ID = "System.Text.Encodings.Web";
        Version = "6.0.0";
        ExistsLocally = $true;
    },
    [PSObject]@{
        ID = "Microsoft.Bcl.AsyncInterfaces";
        Version = "6.0.2-mauipre.1.22054.8";
        ExistsLocally = $true;
    },
    [PSObject]@{
        ID = "System.Runtime.CompilerServices.Unsafe";
        Version = "6.0.2-mauipre.1.22054.8";
        ExistsLocally = $true;
    },
    [PSObject]@{
        ID = "System.Text.Encodings.Web";
        Version = "6.0.2-mauipre.1.22054.8";
        ExistsLocally = $true;
    },
    [PSObject]@{
        ID = "Microsoft.Bcl.AsyncInterfaces";
        Version = "6.0.2-mauipre.1.22102.15";
        ExistsLocally = $true;
    },
    [PSObject]@{
        ID = "System.Runtime.CompilerServices.Unsafe";
        Version = "6.0.2-mauipre.1.22102.15";
        ExistsLocally = $true;
    },
    [PSObject]@{
        ID = "System.Text.Encodings.Web";
        Version = "6.0.2-mauipre.1.22102.15";
        ExistsLocally = $true;
    },
    [PSObject]@{
        ID = "Microsoft.Bcl.AsyncInterfaces";
        Version = "7.0.0";
        ExistsLocally = $true;
    },
    [PSObject]@{
        ID = "System.Text.Encodings.Web";
        Version = "7.0.0";
        ExistsLocally = $true;
    },
    [PSObject]@{
        ID = "System.Memory";
        Version = "4.5.5";
        ExistsLocally = $true;
    }
);
[Uri]$BaseUri = 'https://www.nuget.org/api/v2/package/';
# System.Text.Json/8.0.0-preview.7.23375.6
$LocalRepoPath = $PSScriptRoot | Join-Path -ChildPath 'ExampleLocalNuGetRepo';
$UpstreamRepoPath = $PSScriptRoot | Join-Path -ChildPath 'ExampleUpstreamNuGetRepo';
$AllPackages = @((Get-Content -LiteralPath ($PSScriptRoot | Join-Path -ChildPath 'DownloadedNuGetPackages.json')) | ConvertFrom-Json);
$AllVersions = @($AllPackages | ForEach-Object {
    $ID = $_.ID;
    $_.Versions | Add-Member -MemberType NoteProperty -Name 'ID' -Value $ID -PassThru;
}) + @($ForceDownload);

$DlCount = 0;
$CopyCount = 0;
$WebClient = [System.Net.WebClient]::new();
for ($i = 0; $i -lt $AllVersions.Count; $i++) {
    $Item = $AllVersions[$i];
    $Name = $Item.ID;
    if ($null -ne $Item.Version) { $Name = "$Name.$($Item.Version)" }
    $UpstreamDlPath = $UpstreamRepoPath | Join-Path -ChildPath "$Name.nupkg";
    $LocalDlPath = $LocalRepoPath | Join-Path -ChildPath "$Name.nupkg";
    if ($UpstreamDlPath | Test-Path -PathType Leaf) {
        if ($Item.ExistsLocally) {
            if ($LocalDlPath | Test-Path -PathType Leaf) {
                Write-Information -MessageData "$Name already exists in example local and upstream repositories" -InformationAction Continue;
            } else {
                $CopyCount++;
                Write-Information -MessageData "$Name already exists in example upstream repository" -InformationAction Continue;
                Write-Progress -Activity 'Downloading packages' -Status $Name -CurrentOperation 'Copying to example local repository' -PercentComplete ([int](($i * 100.0) / ([double]$AllVersions.Count)));
                Copy-Item -LiteralPath $UpstreamDlPath -Destination $LocalDlPath;
            }
        } else {
            Write-Information -MessageData "$Name already exists in example upstream repository" -InformationAction Continue;
        }
    } else {
        if ($Item.ExistsLocally) {
            if ($LocalDlPath | Test-Path -PathType Leaf) {
                $CopyCount++;
                Write-Information -MessageData "$Name already exists in example local repository" -InformationAction Continue;
                Write-Progress -Activity 'Downloading packages' -Status $Name -CurrentOperation 'Copying to example upstream repository' -PercentComplete ([int](($i * 100.0) / ([double]$AllVersions.Count)));
                Copy-Item -LiteralPath $LocalDlPath -Destination $UpstreamDlPath;
            } else {
                $DlCount++;
                $UriLeaf = $ID;
                if ($null -ne $Item.Version) { $UriLeaf = "$UriLeaf/$($Item.Version)" }
                $Uri = [Uri]::new($BaseUri, "$UriLeaf");
                Write-Progress -Activity 'Downloading packages' -Status $Name -CurrentOperation 'Downloading' -PercentComplete ([int](($i * 100.0) / ([double]$AllVersions.Count)));
                $WebClient.DownloadFile($Uri.AbsoluteUri, $UpstreamDlPath);
                Write-Progress -Activity 'Downloading packages' -Status $Name -CurrentOperation 'Copying to example local repository' -PercentComplete ([int](($i * 100.0) / ([double]$AllVersions.Count)));
                Copy-Item -LiteralPath $UpstreamDlPath -Destination $LocalDlPath;
            }
        } else {
            $DlCount++;
            $UriLeaf = $ID;
            if ($null -ne $Item.Version) { $UriLeaf = "$UriLeaf/$($Item.Version)" }
            $Uri = [Uri]::new($BaseUri, "$UriLeaf");
            Write-Progress -Activity 'Downloading packages' -Status $Name -CurrentOperation 'Downloading' -PercentComplete ([int](($i * 100.0) / ([double]$AllVersions.Count)));
            $WebClient.DownloadFile($Uri.AbsoluteUri, $UpstreamDlPath);
        }
    }
}
if ($DlCount -eq 1) {
    if ($CopyCount -eq 1) {
        $Message =  "1 package downloaded; 1 package copied";
    } else {
        if ($CopyCount -gt 0) {
            $Message =  "1 package downloaded; $CopyCount packages copied";
        } else {
            $Message =  "1 package downloaded";
        }
    }
} else {
    if ($DlCount -gt 1) {
        if ($CopyCount -eq 1) {
            $Message =  "$DlCount packages downloaded; 1 package copied";
        } else {
            if ($CopyCount -gt 0) {
                $Message =  "$DlCount packages downloaded; $CopyCount packages copied";
            } else {
                $Message =  "$DlCount packages downloaded";
            }
        }
    } else {
        if ($CopyCount -eq 1) {
            $Message =  "1 package copied";
        } else {
            if ($CopyCount -gt 0) {
                $Message =  "$CopyCount packages copied";
            } else {
                $Message =  "No packages to downloade or copy";
            }
        }
    }
}
Write-Information -MessageData $Message -InformationAction Continue;
Write-Progress -Activity 'Downloading packages' -Status $Message -PercentComplete 100 -Completed;